name: Build (Windows)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-mingw:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup MSYS2 (MinGW-w64)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          git
          make
          mingw-w64-x86_64-binutils
          mingw-w64-x86_64-headers
          mingw-w64-x86_64-crt
          mingw-w64-x86_64-winpthreads
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-pkgconf
          mingw-w64-x86_64-openssl
          mingw-w64-x86_64-rtl-sdr

    - name: Build and install liquid-dsp (MinGW-w64)
      shell: msys2 {0}
      run: |
        git clone --depth 1 https://github.com/jgaeddert/liquid-dsp.git /tmp/liquid-dsp
        cmake -S /tmp/liquid-dsp -B /tmp/liquid-dsp/build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=OFF \
          -DBUILD_EXAMPLES=OFF \
          -DBUILD_AUTOTESTS=OFF \
          -DBUILD_BENCHMARKS=OFF \
          -DBUILD_SANDBOX=OFF \
          -DCMAKE_INSTALL_PREFIX=/mingw64
        cmake --build /tmp/liquid-dsp/build -j$(nproc)
        cmake --install /tmp/liquid-dsp/build

    - name: Build (MinGW-w64)
      shell: msys2 {0}
      run: |
        cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build build -j$(nproc)

    - name: Bundle runtime dependencies (MinGW-w64)
      shell: msys2 {0}
      run: |
        mkdir -p dist/windows-mingw
        cp build/fm-sdr-tuner.exe dist/windows-mingw/

        for dll in \
          libgcc_s_seh-1.dll \
          libstdc++-6.dll \
          libwinpthread-1.dll \
          libssl-3-x64.dll \
          libcrypto-3-x64.dll \
          librtlsdr.dll \
          libliquid.dll; do
          if [ -f "/mingw64/bin/$dll" ]; then
            cp "/mingw64/bin/$dll" dist/windows-mingw/
          fi
        done

    - name: Upload artifact (MinGW-w64)
      uses: actions/upload-artifact@v4
      with:
        name: fm-sdr-tuner-windows-mingw
        path: dist/windows-mingw
